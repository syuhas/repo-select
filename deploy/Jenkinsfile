pipeline {
    agent any

    environment {
        GITHUB_TOKEN = credentials('GITHUB_TOKEN')  // Fetch GitHub token securely
        REPO_LIST_FILE = "${WORKSPACE}/github_repos.txt"  // Store repo list in workspace
    }

    stages {
        stage('Fetch GitHub Repositories') {
            steps {
                script {
                    echo "Fetching repositories from GitHub..."
                    
                    sh """
                    curl -s -L \
                    -H "Accept: application/vnd.github+json" \
                    -H "Authorization: Bearer ${GITHUB_TOKEN}" \
                    -H "X-GitHub-Api-Version: 2022-11-28" \
                    "https://api.github.com/user/repos" | jq -r '.[].clone_url' > ${REPO_LIST_FILE}
                    """

                    echo "Repositories fetched!"
                    sh "cat ${REPO_LIST_FILE}"
                }
            }
        }

        stage('User Selects Repository') {
            steps {
                script {
                    def repoChoices = readFile(REPO_LIST_FILE).trim().split("\n")

                    properties([
                        parameters([
                            choice(name: 'GIT_REPO',
                                choices: repoChoices.join("\n"),
                                description: 'Select the repository to build')
                        ])
                    ])
                }
            }
        }
    }
}